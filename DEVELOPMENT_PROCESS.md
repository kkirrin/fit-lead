# Процесс разработки приложения FitLead

Этот документ описывает ключевые решения, инструменты и сложности в процессе создания проекта.

## 1. Подход и архитектура

Цель — качественный MVP с чистой и масштабируемой архитектурой.

- **Структура монорепо:** `back` (Express + TS) и `front` (Next.js + TS). На бэкенде применена классическая схема `models/controllers/routes`.
- **Реферальная модель:** поле `referralLink` разделено на `referralCode` (идентификатор) и `originalUrl` (цель редиректа) для гибкости и соответствия best practices.

## 2. Использование AI-инструментов

- **Среда:** Cursor IDE как основная, с активным применением AI для ускорения разработки и рефакторинга.
- **Модель:** Google Gemini (через Cursor) помогала в генерации boilerplate, рефакторинге компонентов и составлении MongoDB Aggregation Pipeline.
- **Инженерный контроль:** архитектура, отладка специфических проблем и финальные ревью выполнялись вручную.

## 3. Технические решения и изменения

- **Бэкенд**
  - Настроен CORS с whitelist локальных фронт-оригинов; можно расширять через `FRONTEND_ORIGINS`.
  - В `GET /api/products` добавлена валидация query-параметров (`category`, `sortBy`, `order`, `limit`, `search`) и поддержка `limit`.
  - В обработчике рефералов `GET /ref/:referralCode` добавлена проверка формата `referralCode` (регулярное выражение) до обращения к БД.
  - Улучшен `tsconfig` (`rootDir/outDir`, типы node) и dev-скрипт (nodemon + ts-node).

- **Фронтенд**
  - Если `NEXT_PUBLIC_API_URL` не задан, используется дефолт `http://localhost:5000/api`.
  - Введен контекст профиля `ProfileProvider`; `Sidebar` читает имя/email/аватар из контекста и обновляется сразу после изменений в настройках.
  - Поле аватара превращено в числовой размер `i.pravatar.cc/{size}` (ввод только цифр, предпросмотр, защита от невалидных URL).

- **DX и запуск**
  - Корневой запуск `npm run start` поднимает бэкенд и фронтенд параллельно; сидер данных `npm run data:import` в папке `back`.
  - README обновлён: быстрый старт, переменные окружения, адреса сервисов.

## 4. Основные сложности и их решения

1. **Переменные окружения Next.js:** фронтенд не видел значения из `.env`.
   - Решение: использовать `.env.local` и префикс `NEXT_PUBLIC_` для браузерных переменных.
2. **Согласованность API:** расхождения в названиях полей между фронтом и бэком.
   - Решение: улучшена обработка ошибок и согласованы поля; добавлена валидация входных параметров на бэкенде.

## 5. Возможные улучшения

- Централизованная валидация запросов (zod/joi) и error middleware; нормализованный ответ об ошибках.
- Безопасность: `helmet`, rate-limit, строгий CORS whitelist для production.
- БД и производительность: индексы (`referralCode`, `category`, `createdAt`, по необходимости `clicks`), пагинация, `$inc` для атомарного увеличения кликов.
- Тестирование: unit/integration (Jest/Vitest + Supertest) и e2e.
- Улучшения UX: кнопка copy-to-clipboard для реферальной ссылки, фронт-валидация форм.
